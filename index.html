<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ü¶ê SHRIMP CATCHER - Club Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Press Start 2P', cursive;
            background: radial-gradient(ellipse at center, #1a0a2e 0%, #0d0015 100%);
            min-height: 100dvh;
            overflow: hidden;
            color: #fff;
            touch-action: manipulation;
        }

        /* Scanlines overlay */
        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: repeating-linear-gradient(
                transparent 0px,
                transparent 2px,
                rgba(0, 0, 0, 0.1) 2px,
                rgba(0, 0, 0, 0.1) 4px
            );
            pointer-events: none;
            z-index: 1000;
        }

        /* Stars background */
        .stars {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .star {
            position: absolute;
            width: 4px;
            height: 4px;
            background: #fff;
            border-radius: 50%;
            animation: twinkle 1.5s ease-in-out infinite;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.2); }
        }

        /* Screen container */
        .screen {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100dvh;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            padding: 20px;
            z-index: 10;
        }

        .screen.active {
            display: flex;
        }

        /* Neon text effects */
        .neon-pink {
            color: #ff00ff;
            text-shadow: 0 0 5px #ff00ff, 0 0 10px #ff00ff, 0 0 20px #ff00ff, 0 0 40px #ff00ff;
        }

        .neon-cyan {
            color: #00ffff;
            text-shadow: 0 0 5px #00ffff, 0 0 10px #00ffff, 0 0 20px #00ffff;
        }

        .neon-yellow {
            color: #ffff00;
            text-shadow: 0 0 5px #ffff00, 0 0 10px #ffff00, 0 0 20px #ffff00;
        }

        .neon-green {
            color: #00ff00;
            text-shadow: 0 0 5px #00ff00, 0 0 10px #00ff00, 0 0 20px #00ff00;
        }

        .neon-red {
            color: #ff0000;
            text-shadow: 0 0 5px #ff0000, 0 0 10px #ff0000, 0 0 20px #ff0000;
        }

        /* Title */
        .title {
            font-size: clamp(1.2rem, 4vw, 2.5rem);
            margin-bottom: 10px;
            animation: pulse 2s ease-in-out infinite;
        }

        .subtitle {
            font-size: clamp(0.6rem, 2vw, 1rem);
            margin-bottom: 30px;
            color: #00ffff;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* Instructions */
        .instructions {
            font-size: clamp(0.45rem, 1.3vw, 0.75rem);
            line-height: 2.2;
            text-align: center;
            margin-bottom: 30px;
            max-width: 600px;
        }

        .instructions .special-items {
            margin-top: 15px;
            font-size: clamp(0.4rem, 1.2vw, 0.65rem);
            line-height: 2.5;
        }

        /* Buttons */
        .btn {
            font-family: 'Press Start 2P', cursive;
            font-size: clamp(0.6rem, 2vw, 1rem);
            padding: 15px 30px;
            background: linear-gradient(180deg, #ff00ff 0%, #aa00aa 100%);
            border: 4px solid #ff88ff;
            color: #fff;
            cursor: pointer;
            text-transform: uppercase;
            transition: all 0.2s;
            margin: 10px;
        }

        .btn:hover {
            transform: scale(1.1);
            box-shadow: 0 0 20px #ff00ff, 0 0 40px #ff00ff;
        }

        .btn:active {
            transform: scale(0.95);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Input */
        .name-input {
            font-family: 'Press Start 2P', cursive;
            font-size: clamp(0.8rem, 2vw, 1.2rem);
            padding: 15px 20px;
            background: #1a0a2e;
            border: 4px solid #00ffff;
            color: #00ffff;
            text-align: center;
            width: 100%;
            max-width: 400px;
            margin-bottom: 10px;
        }

        .name-input:focus {
            outline: none;
            box-shadow: 0 0 20px #00ffff;
        }

        .name-input::placeholder {
            color: #006666;
        }

        .name-error {
            color: #ff4444;
            font-size: clamp(0.4rem, 1.2vw, 0.6rem);
            min-height: 1.5em;
            margin-bottom: 15px;
        }

        /* Game UI */
        #game-screen {
            padding: 0;
        }

        .game-ui {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            font-size: clamp(0.5rem, 1.8vw, 0.9rem);
            background: rgba(0, 0, 0, 0.7);
            z-index: 100;
        }

        .hourglass-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .hourglass-bar {
            width: 80px;
            height: 14px;
            border: 2px solid #00ffff;
            background: transparent;
            position: relative;
        }

        .hourglass-fill {
            height: 100%;
            background: #00ffff;
            transition: width 0.1s linear, background-color 0.3s;
        }

        .hourglass-fill.warning {
            background: #ffff00;
        }

        .hourglass-fill.danger {
            background: #ff0000;
            animation: flashDanger 0.3s infinite;
        }

        @keyframes flashDanger {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        #game-canvas {
            display: block;
            max-width: 100%;
            max-height: 100%;
            cursor: crosshair;
        }

        /* Countdown overlay */
        #countdown-screen {
            background: rgba(0, 0, 0, 0.85);
        }

        .countdown-number {
            font-size: clamp(4rem, 15vw, 10rem);
            animation: countdownPop 0.8s ease-out;
        }

        @keyframes countdownPop {
            0% { transform: scale(3); opacity: 0; }
            30% { transform: scale(1); opacity: 1; }
            100% { transform: scale(0.8); opacity: 0.5; }
        }

        /* End screen */
        #end-screen {
            overflow-y: auto;
            justify-content: flex-start;
            padding-top: 30px;
            padding-bottom: 30px;
        }

        .score-display {
            font-size: clamp(0.8rem, 2.5vw, 1.5rem);
            margin: 15px 0;
        }

        .leaderboard {
            background: rgba(0, 0, 0, 0.5);
            border: 3px solid #ff00ff;
            padding: 20px;
            margin: 15px 0;
            max-width: 400px;
            width: 100%;
        }

        .leaderboard h3 {
            font-size: clamp(0.6rem, 1.8vw, 0.9rem);
            margin-bottom: 15px;
            color: #ff00ff;
        }

        .leaderboard-entry {
            display: flex;
            justify-content: space-between;
            font-size: clamp(0.4rem, 1.2vw, 0.7rem);
            padding: 8px 0;
            border-bottom: 1px solid #333;
        }

        .leaderboard-entry.highlight {
            color: #ffff00;
            background: rgba(255, 255, 0, 0.1);
        }

        .invitation {
            background: linear-gradient(180deg, rgba(255,0,255,0.2) 0%, rgba(0,255,255,0.2) 100%);
            border: 3px solid #00ffff;
            padding: 25px;
            margin: 15px 0;
            max-width: 450px;
            width: 100%;
            text-align: center;
        }

        .invitation h2 {
            font-size: clamp(0.7rem, 2vw, 1.1rem);
            margin-bottom: 20px;
            animation: rainbow 3s linear infinite;
        }

        @keyframes rainbow {
            0% { color: #ff00ff; }
            33% { color: #00ffff; }
            66% { color: #ffff00; }
            100% { color: #ff00ff; }
        }

        .invitation p {
            font-size: clamp(0.5rem, 1.5vw, 0.8rem);
            line-height: 2.5;
            margin: 10px 0;
        }

        .invitation .detail {
            font-size: clamp(0.6rem, 1.8vw, 0.9rem);
        }

        /* Shrimp emoji styling */
        .shrimp-icon {
            font-size: 1.5em;
            display: inline-block;
            animation: wiggle 0.5s ease-in-out infinite;
        }

        @keyframes wiggle {
            0%, 100% { transform: rotate(-5deg); }
            50% { transform: rotate(5deg); }
        }

        /* Loading */
        .loading {
            font-size: 0.8rem;
            color: #888;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        /* Catch/Miss animation */
        .catch-popup {
            position: fixed;
            font-family: 'Press Start 2P', cursive;
            font-size: 1.2rem;
            pointer-events: none;
            animation: catchPop 0.7s ease-out forwards;
            z-index: 200;
        }

        .catch-popup.miss {
            color: #ff4444;
            text-shadow: 0 0 10px #ff0000;
        }

        .catch-popup.catch {
            color: #00ff00;
            text-shadow: 0 0 10px #00ff00;
        }

        .catch-popup.special {
            color: #ffff00;
            text-shadow: 0 0 15px #ffff00;
            font-size: 1.5rem;
        }

        @keyframes catchPop {
            0% { transform: scale(1) translateY(0); opacity: 1; }
            100% { transform: scale(1.5) translateY(-40px); opacity: 0; }
        }

        /* Mobile adjustments */
        @media (max-width: 600px) {
            .instructions {
                line-height: 2.5;
            }

            .game-ui {
                padding: 8px 12px;
            }

            .hourglass-bar {
                width: 60px;
                height: 12px;
            }
        }
    </style>
</head>
<body>
    <!-- Stars background -->
    <div class="stars" id="stars"></div>

    <!-- INTRO SCREEN -->
    <div class="screen active" id="intro-screen">
        <div class="title neon-pink">
            <span class="shrimp-icon">ü¶ê</span> SHRIMP CATCHER <span class="shrimp-icon">ü¶ê</span>
        </div>
        <div class="subtitle">~ CLUB EDITION ~</div>

        <div class="instructions">
            <span class="neon-cyan">Vang shrimps voor de zandloper afloopt!</span><br><br>
            Klik of tap om je hengel uit te werpen.<br>
            Elke vangst reset de timer,<br>
            maar hij wordt steeds korter...<br>
            En de shrimps worden kleiner!<br><br>
            <div class="special-items">
                <span class="neon-yellow">~ SPECIALE ITEMS ~</span><br>
                üë∂ Baby = dubbele punten<br>
                üç´ Chocolade = triple punten<br>
                üçÑ Paddestoel = 4 punten<br>
                ü•É Baco = extra tijd!<br>
            </div>
        </div>

        <button class="btn" onclick="showNameScreen()">START GAME</button>
    </div>

    <!-- NAME INPUT SCREEN -->
    <div class="screen" id="name-screen">
        <div class="title neon-cyan" style="font-size: clamp(0.8rem, 2.5vw, 1.5rem);">WAT IS JE NAAM?</div>
        <br><br>
        <input type="text" class="name-input" id="player-name" placeholder="Jouw naam..." maxlength="15" autocomplete="off">
        <div class="name-error" id="name-error"></div>
        <button class="btn" id="start-btn" onclick="validateAndStart()">VERDER</button>
    </div>

    <!-- COUNTDOWN SCREEN -->
    <div class="screen" id="countdown-screen">
        <div class="countdown-number neon-yellow" id="countdown-text">3</div>
    </div>

    <!-- GAME SCREEN -->
    <div class="screen" id="game-screen">
        <div class="game-ui">
            <div class="neon-yellow">SCORE: <span id="score">0</span></div>
            <div class="hourglass-container">
                <span class="neon-cyan">‚è≥</span>
                <div class="hourglass-bar">
                    <div class="hourglass-fill" id="hourglass-fill" style="width: 100%"></div>
                </div>
            </div>
        </div>
        <canvas id="game-canvas"></canvas>
    </div>

    <!-- END SCREEN -->
    <div class="screen" id="end-screen">
        <div class="title neon-pink" style="font-size: clamp(1rem, 3vw, 2rem);">GAME OVER!</div>

        <div class="score-display neon-yellow">
            Je scoorde: <span id="final-score">0</span> punten! ü¶ê
        </div>

        <div class="leaderboard">
            <h3 class="neon-pink">‚ïê‚ïê‚ïê RANGLIJST ‚ïê‚ïê‚ïê</h3>
            <div id="leaderboard-entries">
                <div class="loading">Laden...</div>
            </div>
        </div>

        <div class="invitation">
            <h2>üéâ JE BENT UITGENODIGD! üéâ</h2>
            <p><span class="neon-pink">Fee & Leon</span> worden jarig!</p>
            <p class="detail">üìÖ <span class="neon-cyan">13 februari</span></p>
            <p class="detail">üï¢ <span class="neon-cyan">20:30</span></p>
            <p class="detail">üìç <span class="neon-cyan">De Kleine Bes</span></p>
            <br>
            <p class="neon-green">Tot dan! ü¶êüéâ</p>
        </div>

        <button class="btn" onclick="playAgain()">SPEEL OPNIEUW</button>
    </div>

    <script>
        // ============================================
        // CONFIGURATION
        // ============================================

        // GitHub Gist configuration for permanent shared leaderboard
        const GIST_ID = '969054c1be1035d3683f9c16630f5791';
        const GIST_API = `https://api.github.com/gists/${GIST_ID}`;
        const GIST_TOKEN = atob('Z2hwX0tydFdaS2JTWUV3UlNhdnJwRHFocmNCMjR0c1cyYjNlYndSaw==');

        // Game settings
        const SHRIMP_COUNT = 8;
        const SHRIMP_SPEED = 2;
        const CATCH_RADIUS = 50;
        const INITIAL_SHRIMP_SIZE_MIN = 75;   // 2.5x bigger than original 30
        const INITIAL_SHRIMP_SIZE_MAX = 112;  // 2.5x bigger than original 45
        const MIN_SHRIMP_SIZE = 18;
        const HOURGLASS_INITIAL = 5.0;        // seconds
        const HOURGLASS_DECAY = 0.95;         // 5% shorter each catch
        const HOURGLASS_MIN = 1.0;            // minimum seconds

        // Special item config
        const SPECIAL_SPAWN_CHANCE = 0.03;    // 3% per second per type
        const SPECIAL_LIFETIME = 4000;        // ms before disappearing
        const SPECIAL_SPEED_MULT = 1.8;       // faster than shrimps
        const SPECIAL_TYPES = [
            { type: 'baby',       emoji: 'üë∂', points: 2, effect: null,       sound: 'baby' },
            { type: 'baco',       emoji: 'ü•É', points: 1, effect: 'addTime',  sound: 'letsgo' },
            { type: 'chocolade',  emoji: 'üç´', points: 3, effect: null,       sound: 'woeei' },
            { type: 'paddestoel', emoji: 'üçÑ', points: 4, effect: null,       sound: 'ziekelach' },
        ];

        // ============================================
        // GAME STATE
        // ============================================

        let playerName = '';
        let score = 0;
        let gameRunning = false;
        let shrimps = [];
        let specialItems = [];
        let canvas, ctx;
        let canvasWidth, canvasHeight;
        let hookX, hookY;
        let hookActive = false;
        let hookTargetX, hookTargetY;
        let hookProgress = 0;
        let animFrameId = null;
        let hourglassTime = HOURGLASS_INITIAL;
        let hourglassRemaining = HOURGLASS_INITIAL;
        let hourglassInterval = null;
        let specialSpawnInterval = null;
        let currentShrimpScale = 1.0;
        let existingNames = null;  // null = not yet loaded
        let clickHandler = null;
        let touchHandler = null;
        let resizeHandler = null;

        // ============================================
        // AUDIO ENGINE (Web Audio API)
        // ============================================

        let audioCtx = null;

        function getAudioCtx() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
            return audioCtx;
        }

        function playTone(freq, duration, type = 'square', volume = 0.15) {
            const ctx = getAudioCtx();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, ctx.currentTime);
            gain.gain.setValueAtTime(volume, ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + duration);
            osc.connect(gain);
            gain.connect(ctx.destination);
            osc.start();
            osc.stop(ctx.currentTime + duration);
        }

        function playCatchSound() {
            playTone(880, 0.08, 'square', 0.12);
            setTimeout(() => playTone(1200, 0.1, 'square', 0.12), 80);
        }

        function playMissSound() {
            playTone(200, 0.15, 'sawtooth', 0.08);
            setTimeout(() => playTone(150, 0.2, 'sawtooth', 0.06), 100);
        }

        function playCountdownBeep(pitch) {
            playTone(pitch, 0.15, 'square', 0.2);
        }

        function playGoSound() {
            playTone(523, 0.1, 'square', 0.2);
            setTimeout(() => playTone(659, 0.1, 'square', 0.2), 100);
            setTimeout(() => playTone(784, 0.1, 'square', 0.2), 200);
            setTimeout(() => playTone(1047, 0.2, 'square', 0.25), 300);
        }

        function playGameOverSound() {
            playTone(400, 0.2, 'sawtooth', 0.15);
            setTimeout(() => playTone(300, 0.2, 'sawtooth', 0.15), 200);
            setTimeout(() => playTone(200, 0.4, 'sawtooth', 0.15), 400);
        }

        function playBabyLaugh() {
            // Synth baby giggle: quick ascending chirps
            const freqs = [600, 800, 700, 900, 750, 950];
            freqs.forEach((f, i) => {
                setTimeout(() => playTone(f, 0.07, 'sine', 0.15), i * 60);
            });
        }

        function playLetsGo() {
            try {
                const u = new SpeechSynthesisUtterance("OKAAAY LETS GOOO!");
                u.rate = 0.9;
                u.pitch = 1.8;
                u.volume = 1.0;
                // Try to find an energetic/male voice
                const voices = speechSynthesis.getVoices();
                const loud = voices.find(v => /male|daniel|google/i.test(v.name) && v.lang.startsWith('en'));
                if (loud) u.voice = loud;
                u.lang = 'en-US';
                speechSynthesis.speak(u);
            } catch(e) {
                playTone(500, 0.1); playTone(700, 0.15);
            }
        }

        function playWoeei() {
            try {
                const u = new SpeechSynthesisUtterance("Woeei!");
                u.rate = 1.2;
                u.pitch = 1.5;
                u.volume = 0.8;
                speechSynthesis.speak(u);
            } catch(e) {
                playTone(400, 0.1); playTone(800, 0.2);
            }
        }

        function playZiekeLach() {
            // Creepy descending wobble
            const ctx = getAudioCtx();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(800, ctx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(200, ctx.currentTime + 0.4);
            osc.frequency.exponentialRampToValueAtTime(600, ctx.currentTime + 0.5);
            osc.frequency.exponentialRampToValueAtTime(150, ctx.currentTime + 0.8);
            gain.gain.setValueAtTime(0.12, ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.9);
            osc.connect(gain);
            gain.connect(ctx.destination);
            osc.start();
            osc.stop(ctx.currentTime + 0.9);
        }

        const specialSounds = {
            baby: playBabyLaugh,
            letsgo: playLetsGo,
            woeei: playWoeei,
            ziekelach: playZiekeLach,
        };

        // (shrimps use emoji rendering)

        // ============================================
        // STARS BACKGROUND
        // ============================================

        function createStars() {
            const starsContainer = document.getElementById('stars');
            for (let i = 0; i < 50; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                star.style.animationDelay = Math.random() * 2 + 's';
                star.style.width = (Math.random() * 3 + 2) + 'px';
                star.style.height = star.style.width;
                starsContainer.appendChild(star);
            }
        }

        // ============================================
        // SCREEN MANAGEMENT
        // ============================================

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        function showNameScreen() {
            // Initialize audio context on user gesture
            getAudioCtx();
            showScreen('name-screen');
            document.getElementById('player-name').focus();
            document.getElementById('name-error').textContent = '';
            // Pre-fetch existing names
            fetchExistingNames();
        }

        async function readGistData() {
            const response = await fetch(GIST_API);
            if (!response.ok) throw new Error('Gist read failed');
            const gist = await response.json();
            const content = gist.files['leaderboard.json'].content;
            return JSON.parse(content);
        }

        async function writeGistData(data) {
            const response = await fetch(GIST_API, {
                method: 'PATCH',
                headers: {
                    'Authorization': `token ${GIST_TOKEN}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    files: {
                        'leaderboard.json': {
                            content: JSON.stringify(data)
                        }
                    }
                })
            });
            if (!response.ok) throw new Error('Gist write failed');
        }

        async function fetchExistingNames() {
            try {
                const data = await readGistData();
                existingNames = (data.scores || []).map(s => s.name.toLowerCase());
            } catch(e) {
                existingNames = null;
            }
        }

        async function validateAndStart() {
            const nameInput = document.getElementById('player-name');
            const name = nameInput.value.trim();
            const errorEl = document.getElementById('name-error');
            const btn = document.getElementById('start-btn');

            if (!name) {
                errorEl.textContent = 'Vul een naam in!';
                return;
            }

            // Always fetch fresh names before validating
            btn.disabled = true;
            btn.textContent = 'CHECKEN...';
            await fetchExistingNames();
            btn.disabled = false;
            btn.textContent = 'VERDER';

            // Only block if we successfully loaded names and found a duplicate
            if (existingNames !== null && existingNames.includes(name.toLowerCase())) {
                errorEl.textContent = 'Naam al gebruikt!';
                return;
            }

            playerName = name;
            errorEl.textContent = '';
            startCountdown();
        }

        // ============================================
        // N64-STYLE COUNTDOWN
        // ============================================

        function startCountdown() {
            showScreen('countdown-screen');
            const textEl = document.getElementById('countdown-text');
            let count = 3;

            textEl.textContent = count;
            textEl.className = 'countdown-number neon-yellow';
            playCountdownBeep(440);

            const countInterval = setInterval(() => {
                count--;
                if (count > 0) {
                    textEl.textContent = count;
                    textEl.style.animation = 'none';
                    void textEl.offsetWidth; // reflow
                    textEl.style.animation = 'countdownPop 0.8s ease-out';
                    playCountdownBeep(440 + (3 - count) * 100);
                } else if (count === 0) {
                    textEl.textContent = 'GO!';
                    textEl.className = 'countdown-number neon-green';
                    textEl.style.animation = 'none';
                    void textEl.offsetWidth;
                    textEl.style.animation = 'countdownPop 0.8s ease-out';
                    playGoSound();
                } else {
                    clearInterval(countInterval);
                    startGame();
                }
            }, 900);
        }

        // ============================================
        // GAME INITIALIZATION
        // ============================================

        function startGame() {
            showScreen('game-screen');

            // Setup canvas
            canvas = document.getElementById('game-canvas');
            ctx = canvas.getContext('2d');

            resizeCanvas();

            // Clean up old handlers
            if (clickHandler) canvas.removeEventListener('click', clickHandler);
            if (touchHandler) canvas.removeEventListener('touchstart', touchHandler);
            if (resizeHandler) window.removeEventListener('resize', resizeHandler);

            // Create new handlers
            clickHandler = handleClick;
            touchHandler = handleTouch;
            resizeHandler = resizeCanvas;

            canvas.addEventListener('click', clickHandler);
            canvas.addEventListener('touchstart', touchHandler, { passive: false });
            window.addEventListener('resize', resizeHandler);

            // Reset game state
            score = 0;
            hookActive = false;
            gameRunning = true;
            currentShrimpScale = 1.0;
            specialItems = [];
            hourglassTime = HOURGLASS_INITIAL;
            hourglassRemaining = HOURGLASS_INITIAL;

            document.getElementById('score').textContent = score;
            updateHourglassDisplay();

            // Spawn shrimps
            spawnShrimps();

            // Start game loop
            gameLoop();

            // Start hourglass
            startHourglass();

            // Start special item spawner
            specialSpawnInterval = setInterval(trySpawnSpecial, 1000);
        }

        function resizeCanvas() {
            const ui = document.querySelector('.game-ui');
            const uiHeight = ui ? ui.offsetHeight : 50;

            canvasWidth = window.innerWidth;
            canvasHeight = (window.innerHeight || document.documentElement.clientHeight) - uiHeight;

            canvas.width = canvasWidth;
            canvas.height = canvasHeight;
            canvas.style.marginTop = uiHeight + 'px';
        }

        // ============================================
        // HOURGLASS TIMER
        // ============================================

        function startHourglass() {
            const tickRate = 50; // ms
            hourglassInterval = setInterval(() => {
                if (!gameRunning) return;

                hourglassRemaining -= tickRate / 1000;
                updateHourglassDisplay();

                if (hourglassRemaining <= 0) {
                    endGame();
                }
            }, tickRate);
        }

        function resetHourglass() {
            hourglassTime = Math.max(HOURGLASS_MIN, hourglassTime * HOURGLASS_DECAY);
            hourglassRemaining = hourglassTime;
            updateHourglassDisplay();
        }

        function addHourglassTime(seconds) {
            hourglassRemaining = Math.min(hourglassRemaining + seconds, hourglassTime + seconds);
            updateHourglassDisplay();
        }

        function updateHourglassDisplay() {
            const fill = document.getElementById('hourglass-fill');
            const pct = Math.max(0, (hourglassRemaining / hourglassTime) * 100);
            fill.style.width = pct + '%';

            fill.classList.remove('warning', 'danger');
            if (pct < 25) {
                fill.classList.add('danger');
            } else if (pct < 50) {
                fill.classList.add('warning');
            }
        }

        // ============================================
        // SHRIMP MANAGEMENT
        // ============================================

        function getShrimpSize() {
            // Shrimps shrink as score increases
            const shrinkFactor = Math.max(0.25, 1 - (score * 0.02));
            currentShrimpScale = shrinkFactor;
            const minS = INITIAL_SHRIMP_SIZE_MIN * shrinkFactor;
            const maxS = INITIAL_SHRIMP_SIZE_MAX * shrinkFactor;
            return Math.max(MIN_SHRIMP_SIZE, minS + Math.random() * (maxS - minS));
        }

        function spawnShrimps() {
            shrimps = [];
            const margin = 60;
            for (let i = 0; i < SHRIMP_COUNT; i++) {
                shrimps.push(createShrimp(margin));
            }
        }

        function createShrimp(margin) {
            margin = margin || 60;
            const size = getShrimpSize();
            return {
                x: margin + Math.random() * (canvasWidth - margin * 2),
                y: margin + Math.random() * (canvasHeight - margin * 2),
                vx: (Math.random() - 0.5) * SHRIMP_SPEED * 2,
                vy: (Math.random() - 0.5) * SHRIMP_SPEED * 2,
                size: size,
                rotation: Math.random() * Math.PI * 2,
                wiggle: Math.random() * Math.PI * 2
            };
        }

        function updateShrimps() {
            const margin = 40;
            shrimps.forEach(shrimp => {
                shrimp.x += shrimp.vx;
                shrimp.y += shrimp.vy;

                shrimp.wiggle += 0.2;
                shrimp.rotation = Math.sin(shrimp.wiggle) * 0.3;

                // Bounce off walls with margin
                if (shrimp.x < margin || shrimp.x > canvasWidth - margin) {
                    shrimp.vx *= -1;
                    shrimp.x = Math.max(margin, Math.min(canvasWidth - margin, shrimp.x));
                }
                if (shrimp.y < margin || shrimp.y > canvasHeight - margin) {
                    shrimp.vy *= -1;
                    shrimp.y = Math.max(margin, Math.min(canvasHeight - margin, shrimp.y));
                }

                // Random direction change
                if (Math.random() < 0.01) {
                    shrimp.vx += (Math.random() - 0.5) * SHRIMP_SPEED;
                    shrimp.vy += (Math.random() - 0.5) * SHRIMP_SPEED;

                    const speed = Math.sqrt(shrimp.vx * shrimp.vx + shrimp.vy * shrimp.vy);
                    if (speed > SHRIMP_SPEED * 2) {
                        shrimp.vx = (shrimp.vx / speed) * SHRIMP_SPEED * 2;
                        shrimp.vy = (shrimp.vy / speed) * SHRIMP_SPEED * 2;
                    }
                }
            });
        }

        function drawShrimps() {
            shrimps.forEach(shrimp => {
                ctx.save();
                ctx.translate(shrimp.x, shrimp.y);
                ctx.rotate(shrimp.rotation);
                ctx.font = shrimp.size + 'px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('ü¶ê', 0, 0);
                ctx.restore();
            });
        }

        // ============================================
        // SPECIAL ITEMS
        // ============================================

        function trySpawnSpecial() {
            if (!gameRunning) return;

            SPECIAL_TYPES.forEach(spec => {
                if (Math.random() < SPECIAL_SPAWN_CHANCE) {
                    const margin = 60;
                    specialItems.push({
                        ...spec,
                        x: margin + Math.random() * (canvasWidth - margin * 2),
                        y: margin + Math.random() * (canvasHeight - margin * 2),
                        vx: (Math.random() - 0.5) * SHRIMP_SPEED * SPECIAL_SPEED_MULT * 2,
                        vy: (Math.random() - 0.5) * SHRIMP_SPEED * SPECIAL_SPEED_MULT * 2,
                        size: 70,  // always big and clear
                        spawnTime: Date.now(),
                        rotation: 0,
                        wiggle: Math.random() * Math.PI * 2
                    });
                }
            });
        }

        function updateSpecialItems() {
            const now = Date.now();
            const margin = 40;

            // Remove expired items
            specialItems = specialItems.filter(item => now - item.spawnTime < SPECIAL_LIFETIME);

            specialItems.forEach(item => {
                item.x += item.vx;
                item.y += item.vy;
                item.wiggle += 0.15;
                item.rotation = Math.sin(item.wiggle) * 0.2;

                if (item.x < margin || item.x > canvasWidth - margin) {
                    item.vx *= -1;
                    item.x = Math.max(margin, Math.min(canvasWidth - margin, item.x));
                }
                if (item.y < margin || item.y > canvasHeight - margin) {
                    item.vy *= -1;
                    item.y = Math.max(margin, Math.min(canvasHeight - margin, item.y));
                }
            });
        }

        function drawSpecialItems() {
            specialItems.forEach(item => {
                ctx.save();
                ctx.translate(item.x, item.y);
                ctx.rotate(item.rotation);

                const elapsed = Date.now() - item.spawnTime;
                const pulse = Math.sin(elapsed / 150) * 0.15 + 0.85;

                // Neon glow ring behind the item
                const ringRadius = item.size * 0.55;
                const glowSize = Math.sin(elapsed / 200) * 5 + 15;
                ctx.beginPath();
                ctx.arc(0, 0, ringRadius, 0, Math.PI * 2);
                ctx.strokeStyle = '#ffff00';
                ctx.lineWidth = 3;
                ctx.shadowColor = '#ffff00';
                ctx.shadowBlur = glowSize;
                ctx.stroke();
                ctx.shadowBlur = 0;

                // Draw emoji big and clear
                ctx.globalAlpha = pulse;
                ctx.font = item.size + 'px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(item.emoji, 0, 0);
                ctx.restore();
            });
        }

        // ============================================
        // HOOK / FISHING
        // ============================================

        function handleClick(e) {
            if (!gameRunning || hookActive) return;

            const rect = canvas.getBoundingClientRect();
            castHook(e.clientX - rect.left, e.clientY - rect.top);
        }

        function handleTouch(e) {
            e.preventDefault();
            if (!gameRunning || hookActive) return;

            const rect = canvas.getBoundingClientRect();
            const touch = e.touches[0];
            castHook(touch.clientX - rect.left, touch.clientY - rect.top);
        }

        function castHook(x, y) {
            hookActive = true;
            hookTargetX = x;
            hookTargetY = y;
            hookProgress = 0;
            hookX = canvasWidth / 2;
            hookY = 0;
        }

        function updateHook() {
            if (!hookActive) return;

            hookProgress += 0.1;

            if (hookProgress < 1) {
                hookX = canvasWidth / 2 + (hookTargetX - canvasWidth / 2) * hookProgress;
                hookY = hookTargetY * hookProgress;
            } else if (hookProgress < 2) {
                if (hookProgress < 1.1) {
                    checkCatch();
                }
                const returnProgress = hookProgress - 1;
                hookX = hookTargetX + (canvasWidth / 2 - hookTargetX) * returnProgress;
                hookY = hookTargetY * (1 - returnProgress);
            } else {
                hookActive = false;
            }
        }

        function drawHook() {
            if (!hookActive) {
                // Draw rod at top center
                ctx.strokeStyle = '#8B4513';
                ctx.lineWidth = 4;
                ctx.beginPath();
                ctx.moveTo(canvasWidth / 2, 0);
                ctx.lineTo(canvasWidth / 2, 30);
                ctx.stroke();
                return;
            }

            // Draw fishing line
            ctx.strokeStyle = '#aaa';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(canvasWidth / 2, 0);
            ctx.lineTo(hookX, hookY);
            ctx.stroke();

            // Draw hook
            ctx.font = '30px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('üé£', hookX, hookY);
        }

        function checkCatch() {
            let caught = false;

            // Check special items first
            for (let i = specialItems.length - 1; i >= 0; i--) {
                const item = specialItems[i];
                const dx = item.x - hookX;
                const dy = item.y - hookY;
                const distance = Math.sqrt(dx * dx + dy * dy);

                if (distance < CATCH_RADIUS) {
                    score += item.points;
                    document.getElementById('score').textContent = score;

                    // Play special sound
                    if (specialSounds[item.sound]) {
                        specialSounds[item.sound]();
                    }

                    // Apply effect
                    if (item.effect === 'addTime') {
                        addHourglassTime(1.0);
                    }

                    // Show popup
                    const label = item.emoji + ' +' + item.points;
                    showPopup(item.x, item.y, label, 'special');

                    // Remove item
                    specialItems.splice(i, 1);

                    // Reset hourglass
                    resetHourglass();
                    caught = true;
                    break;
                }
            }

            // Check shrimps
            if (!caught) {
                for (let i = shrimps.length - 1; i >= 0; i--) {
                    const shrimp = shrimps[i];
                    const dx = shrimp.x - hookX;
                    const dy = shrimp.y - hookY;
                    const distance = Math.sqrt(dx * dx + dy * dy);

                    // Scale catch radius with shrimp size
                    const adjustedRadius = CATCH_RADIUS * (shrimp.size / INITIAL_SHRIMP_SIZE_MIN);

                    if (distance < adjustedRadius) {
                        score++;
                        document.getElementById('score').textContent = score;

                        playCatchSound();
                        showPopup(shrimp.x, shrimp.y, '+1 ü¶ê', 'catch');

                        // Remove and respawn shrimp
                        shrimps.splice(i, 1);
                        setTimeout(() => {
                            if (gameRunning) {
                                shrimps.push(createShrimp());
                            }
                        }, 500);

                        // Reset hourglass
                        resetHourglass();
                        caught = true;
                        break;
                    }
                }
            }

            if (!caught) {
                playMissSound();
                showPopup(hookX, hookY, 'MISS!', 'miss');
            }
        }

        function showPopup(x, y, text, type) {
            const popup = document.createElement('div');
            popup.className = 'catch-popup ' + type;
            popup.textContent = text;
            popup.style.left = x + 'px';
            popup.style.top = (y + (canvas ? canvas.offsetTop : 0)) + 'px';
            document.body.appendChild(popup);

            setTimeout(() => popup.remove(), 700);
        }

        // ============================================
        // GAME LOOP
        // ============================================

        function gameLoop() {
            if (!gameRunning) return;

            // Clear canvas
            ctx.clearRect(0, 0, canvasWidth, canvasHeight);

            // Draw water effect
            ctx.fillStyle = 'rgba(0, 50, 100, 0.3)';
            ctx.fillRect(0, 0, canvasWidth, canvasHeight);

            // Update and draw
            updateShrimps();
            drawShrimps();
            updateSpecialItems();
            drawSpecialItems();
            updateHook();
            drawHook();

            animFrameId = requestAnimationFrame(gameLoop);
        }

        // ============================================
        // GAME END
        // ============================================

        function endGame() {
            gameRunning = false;

            // Cleanup
            if (animFrameId) {
                cancelAnimationFrame(animFrameId);
                animFrameId = null;
            }
            if (hourglassInterval) {
                clearInterval(hourglassInterval);
                hourglassInterval = null;
            }
            if (specialSpawnInterval) {
                clearInterval(specialSpawnInterval);
                specialSpawnInterval = null;
            }

            playGameOverSound();

            document.getElementById('final-score').textContent = score;
            showScreen('end-screen');

            // Scroll to top of end screen
            document.getElementById('end-screen').scrollTop = 0;

            // Save and load leaderboard
            saveScore().then(loadLeaderboard);
        }

        function playAgain() {
            // Cleanup event listeners
            if (canvas) {
                if (clickHandler) canvas.removeEventListener('click', clickHandler);
                if (touchHandler) canvas.removeEventListener('touchstart', touchHandler);
            }
            if (resizeHandler) window.removeEventListener('resize', resizeHandler);

            showScreen('name-screen');
            document.getElementById('player-name').value = '';
            document.getElementById('player-name').focus();
            document.getElementById('name-error').textContent = '';
            fetchExistingNames();
        }

        // ============================================
        // LEADERBOARD (JSONblob)
        // ============================================

        async function saveScore(retries = 3) {
            for (let attempt = 0; attempt < retries; attempt++) {
                try {
                    let data;
                    try {
                        data = await readGistData();
                        if (!data.scores) data = { scores: [] };
                    } catch(e) {
                        data = { scores: [] };
                    }

                    // Add new score
                    data.scores.push({
                        name: playerName,
                        score: score,
                        date: new Date().toISOString()
                    });

                    // Sort and keep top 50
                    data.scores.sort((a, b) => b.score - a.score);
                    data.scores = data.scores.slice(0, 50);

                    await writeGistData(data);
                    return;
                } catch (err) {
                    console.error(`Save attempt ${attempt + 1} failed:`, err);
                    if (attempt < retries - 1) {
                        await new Promise(r => setTimeout(r, 500));
                    }
                }
            }
        }

        async function loadLeaderboard() {
            const container = document.getElementById('leaderboard-entries');

            try {
                const data = await readGistData();
                const scores = data.scores || [];

                if (scores.length === 0) {
                    container.innerHTML = '<div style="text-align: center; color: #888;">Nog geen scores!</div>';
                    return;
                }

                // Find player's position
                let playerRank = -1;
                for (let i = 0; i < scores.length; i++) {
                    if (scores[i].name === playerName && scores[i].score === score) {
                        playerRank = i;
                        break;
                    }
                }

                // Show top 10
                let html = '';
                const top10 = scores.slice(0, 10);
                top10.forEach((entry, index) => {
                    const isPlayer = index === playerRank;
                    html += `
                        <div class="leaderboard-entry ${isPlayer ? 'highlight' : ''}">
                            <span>${index + 1}. ${entry.name}</span>
                            <span>${entry.score} pts ${isPlayer ? '‚Üê' : ''}</span>
                        </div>
                    `;
                });

                // If player not in top 10, show their position
                if (playerRank >= 10) {
                    html += `
                        <div class="leaderboard-entry" style="border-top: 2px solid #ff00ff; margin-top: 5px; padding-top: 10px; color: #888;">...</div>
                        <div class="leaderboard-entry highlight">
                            <span>${playerRank + 1}. ${playerName}</span>
                            <span>${score} pts ‚Üê</span>
                        </div>
                    `;
                }

                container.innerHTML = html;

            } catch (err) {
                console.error('Failed to load leaderboard:', err);
                container.innerHTML = `
                    <div class="leaderboard-entry highlight">
                        <span>1. ${playerName}</span>
                        <span>${score} pts</span>
                    </div>
                `;
            }
        }

        // ============================================
        // INITIALIZATION
        // ============================================

        createStars();

        document.getElementById('player-name').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                validateAndStart();
            }
        });

        // Clear name error on typing
        document.getElementById('player-name').addEventListener('input', () => {
            document.getElementById('name-error').textContent = '';
        });
    </script>
</body>
</html>
